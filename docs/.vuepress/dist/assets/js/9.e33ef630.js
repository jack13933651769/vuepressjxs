(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{353:function(t,s,a){"use strict";a.r(s);var n=a(43),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"跨域问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#跨域问题"}},[t._v("#")]),t._v(" 跨域问题")]),t._v(" "),a("h2",{attrs:{id:"什么是跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是跨域"}},[t._v("#")]),t._v(" 什么是跨域")]),t._v(" "),a("ul",[a("li",[t._v("跨域是指一个域下的文档或脚本试图去请求另一个域下的资源，这里跨域是广义的。")]),t._v(" "),a("li",[t._v("广域的跨域：")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(". 资源跳转： A链接、重定向、表单提交\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(". 资源嵌入： "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("link"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("、"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("、"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("img"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("、"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("frame"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("等dom标签，还有样式中background:url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("、@font-face"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("等文件外链\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(". 脚本请求： js发起的ajax请求、dom和js对象的跨域操作等\n")])])]),a("ul",[a("li",[t._v("其实我们说的都是狭义的跨域问题，及浏览器同源策略（因为安全问题），是由浏览器同源策略限制的一类请求场景。")])]),t._v(" "),a("h2",{attrs:{id:"什么是同源策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是同源策略"}},[t._v("#")]),t._v(" 什么是同源策略")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("同源策略/SOP（Same origin policy）是一种约定，由Netscape公司1995年引入浏览器，它是浏览器最核心也是最基本的安全功能，如果缺少了同源策略，浏览器很容易受到XSS,CSFR等攻击。所谓同源指 “"),a("font",{attrs:{color:"red",size:"4"}},[t._v("协议+域名+端口")]),t._v("”三者相同，即便两个不同的域名指向同一个ip地址，也非同源。")],1)]),t._v(" "),a("li",[a("p",[t._v("同源策略限制以下几种行为：")])])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(". Cookie、LocalStorage 和 IndexDB 无法读取\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(". DOM 和 Js对象无法获得\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(". AJAX 请求不能发送\n")])])]),a("h3",{attrs:{id:"常见的跨域场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常见的跨域场景"}},[t._v("#")]),t._v(" 常见的跨域场景")]),t._v(" "),a("table",[a("tr",[a("th",[t._v("URL")]),t._v(" "),a("th",[t._v("说明")]),t._v(" "),a("th",[t._v("是否允许通信")])]),t._v(" "),a("tr",[a("td",[t._v("http://www.jxshouse.club/a.js")]),t._v(" "),a("td",{attrs:{rowspan:"3"}},[t._v("  同一域名，不同文件或路径   ")]),t._v(" "),a("td",{attrs:{rowspan:"3"}},[t._v("允许")])]),t._v(" "),a("tr",[a("td",[t._v("http://www.jxshouse.club/b.js")])]),t._v(" "),a("tr",[a("td",[t._v("http://www.jxshouse.club/lab/c.js")])]),t._v(" "),a("tr",[a("td",[t._v("http://www.jxshouse.club:8000/a.js")]),t._v(" "),a("td",{attrs:{rowspan:"2"}},[t._v("   同一域名，不同端口     ")]),t._v(" "),a("td",{attrs:{rowspan:"2"}},[t._v("不允许")])]),t._v(" "),a("tr",[a("td",[t._v("http://www.jxshouse.club/b.js")])]),t._v(" "),a("tr",[a("td",[t._v("http://www.jxshouse.club/a.js")]),t._v(" "),a("td",{attrs:{rowspan:"2"}},[t._v("   同一域名，不同协议    ")]),t._v(" "),a("td",{attrs:{rowspan:"2"}},[t._v("不允许")])]),t._v(" "),a("tr",[a("td",[t._v("https://www.jxshouse.club/b.js")])]),t._v(" "),a("tr",[a("td",[t._v("http://www.jxshouse.club/a.js")]),t._v(" "),a("td",{attrs:{rowspan:"2"}},[t._v("  域名和域名对应相同ip    ")]),t._v(" "),a("td",{attrs:{rowspan:"2"}},[t._v("不允许")])]),t._v(" "),a("tr",[a("td",[t._v("http://192.168.4.12/b.js ")])]),t._v(" "),a("tr",[a("td",[t._v("http://www.jxshouse.club/a.js")]),t._v(" "),a("td",{attrs:{rowspan:"3"}},[t._v("  主域相同，子域不同  ")]),t._v(" "),a("td",{attrs:{rowspan:"3"}},[t._v("允许")])]),t._v(" "),a("tr",[a("td",[t._v("http://x.jxshouse.club/b.js ")])]),t._v(" "),a("tr",[a("td",[t._v("http://jxshouse.club/c.js")])]),t._v(" "),a("tr",[a("td",[t._v("http://www.jxshouse1.club/a.js")]),t._v(" "),a("td",{attrs:{rowspan:"2"}},[t._v("    不同域名      ")]),t._v(" "),a("td",{attrs:{rowspan:"2"}},[t._v("不允许")])]),t._v(" "),a("tr",[a("td",[t._v("http://192.168.4.12/b.js ")])])]),t._v(" "),a("h2",{attrs:{id:"跨域解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#跨域解决方案"}},[t._v("#")]),t._v(" 跨域解决方案")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("、 通过jsonp跨域\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("、 跨域资源共享（CORS）\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("、 nodejs中间件代理跨域\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("、 nginx代理跨域 \n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("、 postMessage跨域 \n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v("、 WebSocket协议跨域\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v("、 location.hash + iframe \n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("、 document.domain + iframe跨域\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),t._v("、 window.name + iframe跨域\n")])])]),a("h4",{attrs:{id:"_1、-通过jsonp跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、-通过jsonp跨域"}},[t._v("#")]),t._v(" 1、 通过jsonp跨域")]),t._v(" "),a("p",[t._v("通常为了减轻web服务器的负载，我们把js、css，img等静态资源分离到另一台独立域名的服务器上，在html页面中再通过相应的标签从不同域名下加载静态资源，而被浏览器允许，基于此原理，我们可以通过动态创建script，再请求一个带参网址实现跨域通信。")]),t._v(" "),a("p",[t._v("1.原生js实现")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("let")]),t._v(" script "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document.createElement"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'script'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\tscript.type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'text/javascript'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t//传参一个回调函数名给后端，方便后端返回时执行这个在前端定义的回调函数\n\t\tscript.src"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://www.jxshouse.club:8080/login?user=admin&callback=handleCallback'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t//回调执行函数\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" handleCallback"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\talert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("JSON.stringify"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("/script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("p",[t._v("服务端返回如下（返回时即执行全局函数）")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("\thandleCallback"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'status'")]),t._v(":true,"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'admin'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("后端node.js 代码示例：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("\t"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("let")]),t._v(" querystring "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" require"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'querystring'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("let")]),t._v(" http "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" require"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("let")]),t._v(" server "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" http.createServer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\tserver.on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'request'")]),t._v(",function"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req,res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tvar params "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" qs.parse"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req.url.split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'?'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\tvar fn "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" params.callback"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t//jsonp返回设置\n\t\tres.writeHead"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(","),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Type'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'text/javascript'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\tres.write"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fn+"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'('")]),t._v("+JSON.stringify"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("+"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("')'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\tres.end"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nserver.listen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'8080'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("jsonp缺点：只能实现get一种请求。")]),t._v(" "),a("h4",{attrs:{id:"_2、-跨域资源共享（cors）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、-跨域资源共享（cors）"}},[t._v("#")]),t._v(" 2、  跨域资源共享（CORS）")]),t._v(" "),a("p",[t._v("普通跨域请求：只服务端设置"),a("font",{attrs:{color:"red",size:"4"}},[t._v(" 响应头 Access-Control-Allow-Origin")]),t._v("即可，前端无须设置，若要带cookie请求：前后端都需要设置。")],1),t._v(" "),a("p",[t._v("需注意的是：由于同源策略的限制，所读取的cookie为跨域请求接口所在域的cookie，而非当前页。如果想实现当前页cookie的写入，可参考下文：三、nginx反向代理中设置proxy_cookie_domain 和 四、NodeJs中间件代理中cookieDomainRewrite参数的设置。")]),t._v(" "),a("p",[t._v("目前，所有浏览器都支持该功能(IE8+：IE8/9需要使用XDomainRequest对象来支持CORS)，CORS也已经成为主流的跨域解决方案。")]),t._v(" "),a("p",[t._v("1.前端设置")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("\n// 前端设置是否带cookie\nxhr.withCredentials "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),a("p",[t._v("实例代码：")]),t._v(" "),a("p",[t._v("原生")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("let")]),t._v(" xhr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" new XMLHttpRequest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" //IE8/9需用windos.XDomainRequest兼容\n//前端设置是否带cookie\nxhr.withCredentials "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nxhr.open"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'post'")]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://www.jxshouse.club:8080/login'")]),t._v(",true"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nxhr.setRequestHeader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Type'")]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'application/x-www-form-urlencoded'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nxhr.send"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user=admin'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nxhr.onreadystatechange "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-name function"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tif"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("xhr.readyState "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("xhr.status "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\talert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("xhr.responseText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("axios")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("axios.defaults.withCredentials "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n")])])]),a("p",[t._v("2.服务器设置:")]),t._v(" "),a("p",[t._v("若后端设置成功，前端浏览器控制台则不会出现跨域报错信息，反之，说明没成功。")]),t._v(" "),a("p",[t._v("java")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("/*\n * 导入包：import javax.servlet.http.HttpServletResponse"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n * 接口参数中定义：HttpServletResponse response\n */\n\n// 允许跨域访问的域名：若有端口需写全（协议+域名+端口），若没有端口末尾不用加"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),t._v("\nresponse.setHeader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Access-Control-Allow-Origin"')]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://www.jxshouse1.club"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n\n// 允许前端带认证cookie：启用此项后，上面的域名不能为"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'*'")]),t._v("，必须指定具体的域名，否则浏览器会提示\nresponse.setHeader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Access-Control-Allow-Credentials"')]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n\n// 提示OPTIONS预检时，后端需要设置的两个常用自定义头\nresponse.setHeader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Access-Control-Allow-Headers"')]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type,X-Requested-With"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("Nodejs")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("var http "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" require"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nvar server "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" http.createServer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nvar qs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" require"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'querystring'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nserver.on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'request'")]),t._v(", function"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req, res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    var postData "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    // 数据块接收中\n    req.addListener"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'data'")]),t._v(", function"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chunk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        postData "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" chunk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    // 数据接收完毕\n    req.addListener"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'end'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function-name function"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        postData "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" qs.parse"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("postData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        // 跨域后台设置\n        res.writeHead"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Access-Control-Allow-Credentials'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'true'")]),t._v(",     // 后端允许发送Cookie\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Access-Control-Allow-Origin'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://www.jxshouse1.club'")]),t._v(",    // 允许访问的域（协议+域名+端口）\n            /* \n             * 此处设置的cookie还是domain2的而非domain1，因为后端也不能跨域写cookie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("nginx反向代理可以实现"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("，\n             * 但只要domain2中写入一次cookie认证，后面的跨域接口都能从domain2中获取cookie，从而实现所有的接口都能跨域访问\n             */\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Set-Cookie'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'l=a123456;Path=/;Domain=www.jxshouse2.club;HttpOnly'")]),t._v("  // HttpOnly的作用是让js无法读取cookie\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        res.write"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("JSON.stringify"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("postData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        res.end"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nserver.listen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'8080'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h4",{attrs:{id:"_3、-nginx代理跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3、-nginx代理跨域"}},[t._v("#")]),t._v(" 3、   nginx代理跨域")]),t._v(" "),a("ol",[a("li",[t._v("nignx配置解决iconfont跨域")])]),t._v(" "),a("p",[t._v("浏览器跨域访问js、css、img等常规静态资源被同源策略许可，但iconfont字体文件(eot|otf|ttf|woff|svg) 例外，此时可在nginx的静态资源服务器中加入以下配置。")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("location /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tADD_header Access-Control-Allow-Origin *"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("ol",{attrs:{start:"2"}},[a("li",[t._v("nginx反向代理接口跨域")])]),t._v(" "),a("p",[t._v("跨域原理：同源策略是浏览器的安全策略，不是HTTP协议的一部分。服务器端调用HTTP接口只是使用HTTP协议，不会执行js脚本，不需要同源策略，也就不存在跨域问题。")]),t._v(" "),a("p",[t._v("实现思路：通过nginx配置一个代理服务器（域名与jxshouse相同，端口不同）做跳板机，反向代理访问jxshouse2接口，并且可以顺便修改cookie中的jxshouse信息，方便当前域cookie写入，实现跨域登录。")]),t._v(" "),a("p",[t._v("nginx具体配置:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#proxy服务器\nserver {\n    listen       81;\n    server_name  www.jxshouse1.com;\n\n    location / {\n        proxy_pass   http://www.jxshouse2.com:8080;  #反向代理\n        proxy_cookie_domain www.jxshouse2.com www.jxshouse1.com; #修改cookie里域名\n        index  index.html index.htm;\n\n        # 当用webpack-dev-server等中间件代理接口访问nignx时，此时无浏览器参与，故没有同源限制，下面的跨域配置可不启用\n        add_header Access-Control-Allow-Origin http://www.jxshouse1.com;  #当前端只跨域不带cookie时，可为*\n        add_header Access-Control-Allow-Credentials true;\n    }\n}\n")])])]),a("p",[t._v("前端代码示例：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("var xhr = new XMLHttpRequest();\n\n// 前端开关：浏览器是否读写cookie\nxhr.withCredentials = true;\n\n// 访问nginx中的代理服务器\nxhr.open('get', 'http://www.jxshouse.club:81/?user=admin', true);\nxhr.send();\n")])])]),a("p",[t._v("后台代码示例：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("var http = require('http');\nvar server = http.createServer();\nvar qs = require('querystring');\n\nserver.on('request', function(req, res) {\n    var params = qs.parse(req.url.substring(2));\n\n    // 向前台写cookie\n    res.writeHead(200, {\n        'Set-Cookie': 'l=a123456;Path=/;Domain=www.jxshouse.club;HttpOnly'   // HttpOnly:脚本无法读取\n    });\n\n    res.write(JSON.stringify(params));\n    res.end();\n});\n\nserver.listen('8080');\nconsole.log('Server is running at port 8080...');\n")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);